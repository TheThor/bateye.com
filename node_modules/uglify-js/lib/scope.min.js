"use strict";function SymbolDef(b,a,c){this.name=c.name;this.orig=[c];this.scope=b;this.references=[];this.global=false;this.mangled_name=null;this.undeclared=false;this.index=a;this.id=SymbolDef.next_id++}SymbolDef.next_id=1;SymbolDef.prototype={unmangleable:function(options){if(!options){options={}}return(this.global&&!options.toplevel)||this.undeclared||(!options.eval&&(this.scope.uses_eval||this.scope.uses_with))||(options.keep_fnames&&(this.orig[0] instanceof AST_SymbolLambda||this.orig[0] instanceof AST_SymbolDefun))},mangle:function(c){var b=c.cache&&c.cache.props;if(this.global&&b&&b.has(this.name)){this.mangled_name=b.get(this.name)}else{if(!this.mangled_name&&!this.unmangleable(c)){var d=this.scope;var a=this.orig[0];if(c.ie8&&a instanceof AST_SymbolLambda){d=d.parent_scope}var e;if(e=this.redefined()){this.mangled_name=e.mangled_name||e.name}else{this.mangled_name=d.next_mangled(c,this)}if(this.global&&b){b.set(this.name,this.mangled_name)}}}},redefined:function(){return this.defun&&this.defun.variables.get(this.name)}};AST_Toplevel.DEFMETHOD("figure_out_scope",function(d){d=defaults(d,{cache:null,ie8:false});var c=this;var e=c.parent_scope=null;var f=new Dictionary();var a=null;var b=new TreeWalker(function(i,m){if(i instanceof AST_Catch){var o=e;e=new AST_Scope(i);e.init_scope_vars(o);m();e=o;return true}if(i instanceof AST_Scope){i.init_scope_vars(e);var o=e;var k=a;var n=f;a=e=i;f=new Dictionary();m();e=o;a=k;f=n;return true}if(i instanceof AST_LabeledStatement){var j=i.label;if(f.has(j.name)){throw new Error(string_template("Label {name} defined twice",j))}f.set(j.name,j);m();f.del(j.name);return true}if(i instanceof AST_With){for(var p=e;p;p=p.parent_scope){p.uses_with=true}return}if(i instanceof AST_Symbol){i.scope=e}if(i instanceof AST_Label){i.thedef=i;i.references=[]}if(i instanceof AST_SymbolLambda){a.def_function(i)}else{if(i instanceof AST_SymbolDefun){(i.scope=a.parent_scope).def_function(i)}else{if(i instanceof AST_SymbolVar){a.def_variable(i);if(a!==e){i.mark_enclosed(d);var h=e.find_variable(i);if(i.thedef!==h){i.thedef=h;i.reference(d)}}}else{if(i instanceof AST_SymbolCatch){e.def_variable(i).defun=a}else{if(i instanceof AST_LabelRef){var g=f.get(i.name);if(!g){throw new Error(string_template("Undefined label {name} [{line},{col}]",{name:i.name,line:i.start.line,col:i.start.col}))}i.thedef=g}}}}}});c.walk(b);c.globals=new Dictionary();var b=new TreeWalker(function(k,j){if(k instanceof AST_LoopControl&&k.label){k.label.thedef.references.push(k);return true}if(k instanceof AST_SymbolRef){var h=k.name;if(h=="eval"&&b.parent() instanceof AST_Call){for(var i=k.scope;i&&!i.uses_eval;i=i.parent_scope){i.uses_eval=true}}var g=k.scope.find_variable(h);if(!g){g=c.def_global(k)}else{if(g.scope instanceof AST_Lambda&&h=="arguments"){g.scope.uses_arguments=true}}k.thedef=g;k.reference(d);return true}var l;if(k instanceof AST_SymbolCatch&&(l=k.definition().redefined())){var i=k.scope;while(i){push_uniq(i.enclosed,l);if(i===l.scope){break}i=i.parent_scope}}});c.walk(b);if(d.ie8){c.walk(new TreeWalker(function(k,j){if(k instanceof AST_SymbolCatch){var h=k.name;var g=k.thedef.references;var i=k.thedef.defun;var l=i.find_variable(h)||c.globals.get(h)||i.def_variable(k);g.forEach(function(m){m.thedef=l;m.reference(d)});k.thedef=l;return true}}))}if(d.cache){this.cname=d.cache.cname}});AST_Toplevel.DEFMETHOD("def_global",function(d){var c=this.globals,a=d.name;if(c.has(a)){return c.get(a)}else{var b=new SymbolDef(this,c.size(),d);b.undeclared=true;b.global=true;c.set(a,b);return b}});AST_Scope.DEFMETHOD("init_scope_vars",function(a){this.variables=new Dictionary();this.functions=new Dictionary();this.uses_with=false;this.uses_eval=false;this.parent_scope=a;this.enclosed=[];this.cname=-1});AST_Lambda.DEFMETHOD("init_scope_vars",function(){AST_Scope.prototype.init_scope_vars.apply(this,arguments);this.uses_arguments=false;this.def_variable(new AST_SymbolFunarg({name:"arguments",start:this.start,end:this.end}))});AST_Symbol.DEFMETHOD("mark_enclosed",function(a){var c=this.definition();var b=this.scope;while(b){push_uniq(b.enclosed,c);if(a.keep_fnames){b.functions.each(function(e){push_uniq(c.scope.enclosed,e)})}if(b===c.scope){break}b=b.parent_scope}});AST_Symbol.DEFMETHOD("reference",function(a){this.definition().references.push(this);this.mark_enclosed(a)});AST_Scope.DEFMETHOD("find_variable",function(a){if(a instanceof AST_Symbol){a=a.name}return this.variables.get(a)||(this.parent_scope&&this.parent_scope.find_variable(a))});AST_Scope.DEFMETHOD("def_function",function(a){this.functions.set(a.name,this.def_variable(a))});AST_Scope.DEFMETHOD("def_variable",function(b){var a;if(!this.variables.has(b.name)){a=new SymbolDef(this,this.variables.size(),b);this.variables.set(b.name,a);a.global=!this.parent_scope}else{a=this.variables.get(b.name);a.orig.push(b)}return b.thedef=a});AST_Scope.DEFMETHOD("next_mangled",function(d){var f=this.enclosed;out:while(true){var a=base54(++this.cname);if(!is_identifier(a)){continue}if(d.reserved.indexOf(a)>=0){continue}for(var e=f.length;--e>=0;){var b=f[e];var c=b.mangled_name||(b.unmangleable(d)&&b.name);if(a==c){continue out}}return a}});AST_Function.DEFMETHOD("next_mangled",function(b,e){var d=e.orig[0] instanceof AST_SymbolFunarg&&this.name&&this.name.definition();var c=d?d.mangled_name||d.name:null;while(true){var a=AST_Lambda.prototype.next_mangled.call(this,b,e);if(!c||c!=a){return a}}});AST_Symbol.DEFMETHOD("unmangleable",function(a){var b=this.definition();return !b||b.unmangleable(a)});AST_Label.DEFMETHOD("unmangleable",return_false);AST_Symbol.DEFMETHOD("unreferenced",function(){return this.definition().references.length==0&&!(this.scope.uses_eval||this.scope.uses_with)});AST_Symbol.DEFMETHOD("undeclared",function(){return this.definition().undeclared});AST_LabelRef.DEFMETHOD("undeclared",return_false);AST_Label.DEFMETHOD("undeclared",return_false);AST_Symbol.DEFMETHOD("definition",function(){return this.thedef});AST_Symbol.DEFMETHOD("global",function(){return this.definition().global});AST_Toplevel.DEFMETHOD("_default_mangler_options",function(options){options=defaults(options,{eval:false,ie8:false,keep_fnames:false,reserved:[],toplevel:false});if(!Array.isArray(options.reserved)){options.reserved=[]}return options});AST_Toplevel.DEFMETHOD("mangle_names",function(c){c=this._default_mangler_options(c);c.reserved.push("arguments");var b=-1;var d=[];if(c.cache){this.globals.each(function(e){if(c.reserved.indexOf(e.name)<0){d.push(e)}})}var a=new TreeWalker(function(i,h){if(i instanceof AST_LabeledStatement){var g=b;h();b=g;return true}if(i instanceof AST_Scope){var j=a.parent(),e=[];i.variables.each(function(k){if(c.reserved.indexOf(k.name)<0){e.push(k)}});d.push.apply(d,e);return}if(i instanceof AST_Label){var f;do{f=base54(++b)}while(!is_identifier(f));i.mangled_name=f;return true}if(!c.ie8&&i instanceof AST_SymbolCatch){d.push(i.definition());return}});this.walk(a);d.forEach(function(e){e.mangle(c)});if(c.cache){c.cache.cname=this.cname}});AST_Toplevel.DEFMETHOD("compute_char_frequency",function(b){b=this._default_mangler_options(b);try{AST_Node.prototype.print=function(d,c){this._print(d,c);if(this instanceof AST_Symbol&&!this.unmangleable(b)){base54.consider(this.name,-1)}else{if(b.properties){if(this instanceof AST_Dot){base54.consider(this.property,-1)}else{if(this instanceof AST_Sub){a(this.property)}}}}};base54.consider(this.print_to_string(),1)}finally{AST_Node.prototype.print=AST_Node.prototype._print}base54.sort();function a(c){if(c instanceof AST_String){base54.consider(c.value,-1)}else{if(c instanceof AST_Conditional){a(c.consequent);a(c.alternative)}else{if(c instanceof AST_Sequence){a(c.expressions[c.expressions.length-1])}}}}});var base54=(function(){var f="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_".split("");var d="0123456789".split("");var b,e;function a(){e=Object.create(null);f.forEach(function(h){e[h]=0});d.forEach(function(h){e[h]=0})}g.consider=function(j,k){for(var h=j.length;--h>=0;){e[j[h]]+=k}};function c(i,h){return e[h]-e[i]}g.sort=function(){b=mergeSort(f,c).concat(mergeSort(d,c))};g.reset=a;a();function g(i){var h="",j=54;i++;do{i--;h+=b[i%j];i=Math.floor(i/j);j=64}while(i>0);return h}return g})();